import SwiftUI
import Combine
import Foundation

/// 模块状态枚举
enum ModuleStatus: Int, CaseIterable, Identifiable {
    case offline = 0  // 离线
    case online = 1  // 上线
    case active = 2  // 启动
    case overload = 3  // 超载

    var id: Int { rawValue }

    var name: String {
        switch self {
        case .offline:
            return NSLocalizedString("Module_Status_Offline", comment: "")
        case .online:
            return NSLocalizedString("Module_Status_Online", comment: "")
        case .active:
            return NSLocalizedString("Module_Status_Active", comment: "")
        case .overload:
            return NSLocalizedString("Module_Status_Overload", comment: "")
        }
    }

    var icon: String {
        switch self {
        case .offline:
            return "power.circle"
        case .online:
            return "power.circle.fill"
        case .active:
            return "bolt.circle.fill"
        case .overload:
            return "flame.circle.fill"
        }
    }

    var color: Color {
        switch self {
        case .offline:
            return .gray
        case .online:
            return .green
        case .active:
            return .blue
        case .overload:
            return .red
        }
    }
}

/// 模块状态选择视图
struct ModuleStatusView: View {
    // 可用的状态列表
    let availableStates: [Int]

    // 当前选中的状态
    @Binding var selectedState: Int

    // 是否在编辑模式下
    let isEditable: Bool

    // 状态变化时的回调
    var onStateChanged: ((Int) -> Void)?

    // 过滤后的状态列表
    private var moduleStates: [ModuleStatus] {
        // 根据可用状态筛选枚举值
        return ModuleStatus.allCases.filter { availableStates.contains($0.rawValue) }
    }

    var body: some View {
        // 如果只有一个状态选项，不显示此视图
        if availableStates.count <= 1 {
            EmptyView()
        } else {
            if isEditable {
                // 可编辑模式 - 使用Picker
                Picker("", selection: $selectedState) {
                    ForEach(moduleStates) { state in
                        Label(
                            title: { Text(state.name) },
                            icon: { Image(systemName: state.icon).foregroundColor(state.color) }
                        )
                        .tag(state.rawValue)
                    }
                }
                .pickerStyle(SegmentedPickerStyle())
                .onChange(of: selectedState) { _, newValue in
                    onStateChanged?(newValue)
                }
            } else {
                // 只读模式 - 显示当前状态
                if let state = ModuleStatus(rawValue: selectedState) {
                    HStack {
                        Image(systemName: state.icon)
                            .foregroundColor(state.color)
                        Text(state.name)
                        Spacer()
                    }
                    .padding(.vertical, 8)
                    .padding(.horizontal, 12)
                    .background(Color(UIColor.secondarySystemBackground))
                    .cornerRadius(8)
                }
            }
        }
    }
}

/// 装备设置视图 - 用于显示和修改已安装装备的详细设置
struct ModuleSettingsView: View {
    // 模块和数据依赖
    let module: SimModule
    let databaseManager: DatabaseManager
    let viewModel: FittingEditorViewModel
    let slotFlag: FittingFlag
    let relatedModules: [SimModule]  // 新增：相关模块列表（用于批量操作）
    
    // 回调函数
    var onDelete: () -> Void
    var onReplaceModule: (Int) -> Void
    
    // 环境变量
    @Environment(\.dismiss) var dismiss
    
    // 状态变量
    @State private var moduleDetails: DatabaseListItem? = nil
    @State private var isLoading = true
    @State private var variationsCount: Int = 0
    @State private var selectedModuleState: Int
    @State private var availableModuleStates: [Int] = []
    @State private var chargeGroupIDs: [Int] = []  // 可装载的弹药组ID
    @State private var currentModuleID: Int  // 添加当前模块ID状态变量
    
    // 计算属性：是否为批量操作模式
    private var isBatchMode: Bool {
        return relatedModules.count > 1
    }
    
    // 计算属性：获取当前模块的弹药信息（从viewModel中直接获取，避免SQL查询）
    private var currentModuleCharge: SimCharge? {
        if let currentModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }) {
            return currentModule.charge
        }
        return nil
    }
    
    // 初始化方法
    init(
        module: SimModule,
        slotFlag: FittingFlag,
        databaseManager: DatabaseManager,
        viewModel: FittingEditorViewModel,
        relatedModules: [SimModule] = [],  // 新增参数，默认为空数组
        onDelete: @escaping () -> Void = {},
        onReplaceModule: @escaping (Int) -> Void = { _ in }
    ) {
        self.module = module
        self.slotFlag = slotFlag
        self.databaseManager = databaseManager
        self.viewModel = viewModel
        self.relatedModules = relatedModules.isEmpty ? [module] : relatedModules  // 如果为空，使用当前模块
        self.onDelete = onDelete
        self.onReplaceModule = onReplaceModule
        
        // 使用模块当前状态初始化
        self._selectedModuleState = State(initialValue: module.status)
        self._currentModuleID = State(initialValue: module.typeId)
    }
    
    var body: some View {
        NavigationStack {
            List {
                // 如果是批量模式，显示批量操作信息
                if isBatchMode {
                    Section(header: Text(NSLocalizedString("Fitting_Batch_Operation", comment: ""))) {
                        HStack {
                            Image(systemName: "square.stack.3d.up")
                                .foregroundColor(.blue)
                            VStack(alignment: .leading) {
                                Text(NSLocalizedString("Fitting_Batch_Mode", comment: ""))
                                    .font(.headline)
                                Text(String(format: NSLocalizedString("Fitting_Batch_Mode_Description", comment: ""), relatedModules.count))
                                    .font(.caption)
                                    .foregroundColor(.secondary)
                            }
                            Spacer()
                        }
                        .padding(.vertical, 4)
                    }
                }
                
                Section(header: 
                    HStack {
                        Text(NSLocalizedString("Fitting_Setting_Module", comment: ""))
                        Spacer()
                        if !isLoading, let _ = moduleDetails {
                            NavigationLink(destination: ShowItemInfo(databaseManager: databaseManager, itemID: currentModuleID)) {
                                Text(NSLocalizedString("View_Details", comment: ""))
                                    .font(.caption)
                                    .foregroundColor(.blue)
                            }
                        }
                    }
                ) {
                    if isLoading {
                        HStack {
                            ProgressView()
                            Text(NSLocalizedString("Misc_Loading", comment: ""))
                        }
                    } else if let details = moduleDetails {
                        // 如果是T3D模式槽位，使用T3D模式选择器
                        if slotFlag == .t3dModeSlot0 {
                            NavigationLink(
                                destination: T3DModeSelectorView(
                                    databaseManager: databaseManager,
                                    slotFlag: slotFlag,
                                    onModuleSelected: { modeID in
                                        // 保存当前状态
                                        let previousState = selectedModuleState
                                        
                                        // 直接替换T3D模式
                                        let success = viewModel.replaceModule(typeId: modeID, flag: slotFlag)
                                        
                                        if success {
                                            // 更新当前模块ID
                                            currentModuleID = modeID
                                            
                                            // 重新加载模块信息
                                            loadModuleDetails()
                                            checkVariations()
                                            updateAvailableStates()
                                            loadChargeGroups()
                                            
                                            // 检查之前的状态是否可用
                                            if availableModuleStates.contains(previousState) {
                                                // 保持之前的状态（如果状态没有改变，不需要重新计算）
                                                selectedModuleState = previousState
                                                if let currentModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }),
                                                   currentModule.status != previousState {
                                                    viewModel.updateModuleStatus(flag: slotFlag, newStatus: previousState)
                                                }
                                            } else if !availableModuleStates.isEmpty {
                                                // 如果之前的状态不可用，设置为新模式支持的最高状态
                                                let newState = availableModuleStates.max() ?? 0
                                                selectedModuleState = newState
                                                if let currentModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }),
                                                   currentModule.status != newState {
                                                    viewModel.updateModuleStatus(flag: slotFlag, newStatus: newState)
                                                }
                                            }
                                        }
                                        
                                        // 不需要关闭整个设置页
                                    },
                                    shipTypeID: viewModel.simulationInput.ship.typeId
                                )
                            ) {
                                DatabaseListItemView(
                                    item: details,
                                    showDetails: true
                                )
                            }
                        }
                        // 如果有变体且不是T3D模式槽位，点击跳转到变体列表
                        else if variationsCount > 1 {
                            NavigationLink(
                                destination: ModuleVariationsView(
                                    databaseManager: databaseManager,
                                    typeID: currentModuleID,
                                    onSelectVariation: { variationID in
                                        // 保存当前状态
                                        let previousState = selectedModuleState
                                        
                                        // 替换模块 - 如果是批量模式，会在外部处理
                                        if isBatchMode {
                                            // 批量模式下，调用外部回调
                                            onReplaceModule(variationID)
                                            
                                            // 批量替换完成后，更新内部状态以反映新装备
                                            currentModuleID = variationID
                                            
                                            // 从viewModel中获取更新后的模块信息，避免额外SQL查询
                                            if let updatedModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }) {
                                                // 重新加载模块信息
                                                loadModuleDetails()
                                                checkVariations()
                                                
                                                // 使用更新后的模块属性计算可用状态
                                                availableModuleStates = getAvailableStatuses(
                                                    itemEffects: updatedModule.effects,
                                                    itemAttributes: updatedModule.attributes,
                                                    databaseManager: databaseManager
                                                )
                                                
                                                // 重新加载弹药组信息
                                                chargeGroupIDs = []
                                                for (name, value) in updatedModule.attributesByName {
                                                    if name.hasPrefix("chargeGroup") && value > 0 {
                                                        chargeGroupIDs.append(Int(value))
                                                    }
                                                }
                                                
                                                // 检查之前的状态是否可用
                                                if availableModuleStates.contains(previousState) {
                                                    selectedModuleState = previousState
                                                } else if !availableModuleStates.isEmpty {
                                                    let newState = availableModuleStates.max() ?? 0
                                                    selectedModuleState = newState
                                                }
                                            }
                                        } else {
                                            // 单个模式下，直接替换
                                            let success = viewModel.replaceModule(typeId: variationID, flag: slotFlag)
                                            
                                            if success {
                                                // 更新当前模块ID
                                                currentModuleID = variationID
                                                
                                                // 重新加载模块信息
                                                loadModuleDetails()
                                                checkVariations()
                                                updateAvailableStates()
                                                loadChargeGroups()
                                                
                                                // 检查之前的状态是否可用
                                                if availableModuleStates.contains(previousState) {
                                                    // 保持之前的状态（如果状态没有改变，不需要重新计算）
                                                    selectedModuleState = previousState
                                                    if let currentModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }),
                                                       currentModule.status != previousState {
                                                        viewModel.updateModuleStatus(flag: slotFlag, newStatus: previousState)
                                                    }
                                                } else if !availableModuleStates.isEmpty {
                                                    // 如果之前的状态不可用，设置为新装备支持的最高状态
                                                    let newState = availableModuleStates.max() ?? 0
                                                    selectedModuleState = newState
                                                    if let currentModule = viewModel.simulationInput.modules.first(where: { $0.flag == slotFlag }),
                                                       currentModule.status != newState {
                                                        viewModel.updateModuleStatus(flag: slotFlag, newStatus: newState)
                                                    }
                                                }
                                            }
                                        }
                                        
                                        // 不需要关闭整个设置页
                                    }
                                )
                            ) {
                                DatabaseListItemView(
                                    item: details,
                                    showDetails: true
                                )
                            }
                        } else {
                            // 没有变体时只显示信息
                            DatabaseListItemView(
                                item: details,
                                showDetails: true
                            )
                        }
                    }
                    
                    // 模块状态选择器
                    ModuleStatusSelector(
                        selectedState: $selectedModuleState,
                        availableStates: availableModuleStates,
                        onStateChanged: { newState in
                            // 更新模块状态 - 如果是批量模式，更新所有相关模块
                            if isBatchMode {
                                // 批量更新所有相关模块的状态
                                let flags = relatedModules.compactMap { $0.flag }
                                viewModel.batchUpdateModuleStatus(flags: flags, newStatus: newState)
                                Logger.info("批量更新模块状态: \(relatedModules.count) 个模块状态设置为 \(newState)")
                            } else {
                                // 单个模块更新
                                viewModel.updateModuleStatus(flag: slotFlag, newStatus: newState)
                            }
                        }
                    )
                }
                
                // 如果模块可以装载弹药，显示弹药设置
                if canLoadCharge() {
                    Section(header: Text(NSLocalizedString("Fitting_Setting_Ammo", comment: ""))) {
                        NavigationLink(
                            destination: ChargeSelectionView(
                                databaseManager: databaseManager,
                                chargeGroupIDs: chargeGroupIDs,
                                typeID: currentModuleID,
                                slotFlag: slotFlag,
                                viewModel: viewModel,
                                module: module,
                                relatedModules: relatedModules  // 传递相关模块列表
                            )
                        ) {
                            HStack {
                                Text(NSLocalizedString("Fitting_Ammo", comment: ""))
                                Spacer()
                                if let charge = currentModuleCharge {
                                    Text(charge.name)
                                        .foregroundColor(.secondary)
                                } else {
                                    Text(NSLocalizedString("Misc_Null", comment: ""))
                                        .foregroundColor(.secondary)
                                }
                            }
                        }
                        
                        // 如果当前有弹药，显示清除弹药按钮
                        if currentModuleCharge != nil {
                            Button(action: {
                                // 如果是批量模式，清除所有相关模块的弹药
                                if isBatchMode {
                                    let flags = relatedModules.compactMap { $0.flag }
                                    viewModel.batchRemoveCharge(flags: flags)
                                    Logger.info("批量清除弹药: \(relatedModules.count) 个模块")
                                } else {
                                    viewModel.removeCharge(flag: slotFlag)
                                }
                            }) {
                                Text(NSLocalizedString("Fitting_Setting_Clear_Ammo", comment: ""))
                                    .foregroundColor(.red)
                            }
                        }
                    }
                }
            }
            .navigationTitle(Text(NSLocalizedString("Fitting_Setting_Module", comment: "")))
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button {
                        onDelete()  // 调用删除回调
                        dismiss()
                    } label: {
                        Image(systemName: "trash")
                            .foregroundColor(.red)
                            .frame(width: 30, height: 30)
                            .background(Color(.systemBackground))
                            .clipShape(Circle())
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button {
                        dismiss()
                    } label: {
                        Image(systemName: "xmark")
                            .foregroundColor(.primary)
                            .frame(width: 30, height: 30)
                            .background(Color(.systemBackground))
                            .clipShape(Circle())
                    }
                }
            }
            .onAppear {
                Logger.info("[ModuleSettingsView] selectedSlotFlag: \(slotFlag)")
                Logger.info("[ModuleSettingsView] 模块名称: \(module.name), 模块ID: \(module.typeId), 槽位: \(slotFlag.rawValue)")
                if isBatchMode {
                    Logger.info("[ModuleSettingsView] 批量模式: \(relatedModules.count) 个相关模块")
                }
                loadModuleDetails()
                checkVariations()
                updateAvailableStates()
                loadChargeGroups()
                
                // 检查当前状态是否在可用状态列表中
                if !availableModuleStates.contains(selectedModuleState) && !availableModuleStates.isEmpty {
                    // 如果不在，设置为可用的最高状态
                    let newState = availableModuleStates.max() ?? 0
                    selectedModuleState = newState
                    viewModel.updateModuleStatus(flag: slotFlag, newStatus: newState)
                }
            }
        }
        .presentationDetents([.fraction(0.81)])  // 设置为屏幕高度的81%
        .presentationDragIndicator(.visible)  // 显示拖动指示器
    }
    
    // 判断模块是否可以装载弹药
    private func canLoadCharge() -> Bool {
        // 检查是否有已加载的弹药组
        return !chargeGroupIDs.isEmpty
    }
    
    // 加载模块详细信息
    private func loadModuleDetails() {
        isLoading = true
        
        // 使用loadMarketItems方法获取模块数据
        let items = databaseManager.loadMarketItems(
            whereClause: "t.type_id = ?",
            parameters: [currentModuleID]
        )
        
        if let item = items.first {
            moduleDetails = item
        }
        
        isLoading = false
    }
    
    // 检查是否有变体
    private func checkVariations() {
        variationsCount = databaseManager.getVariationsCount(for: currentModuleID)
    }
    
    // 更新可用的模块状态
    private func updateAvailableStates() {
        // 使用现有的getAvailableStatuses函数
        availableModuleStates = getAvailableStatuses(
            itemEffects: module.effects, 
            itemAttributes: module.attributes, 
            databaseManager: databaseManager
        )
        
        // 不自动重置状态，让调用者决定如何处理
    }
    
    // 加载模块可装载的弹药组
    private func loadChargeGroups() {
        chargeGroupIDs = []
        
        // 获取模块的所有属性
        let attrQuery = """
            SELECT ta.attribute_id, ta.value, da.name 
            FROM typeAttributes ta 
            JOIN dogmaAttributes da ON ta.attribute_id = da.attribute_id 
            WHERE ta.type_id = ?
        """
        
        // 执行查询
        if case let .success(rows) = databaseManager.executeQuery(attrQuery, parameters: [currentModuleID]) {
            for row in rows {
                if let name = row["name"] as? String,
                   let value = row["value"] as? Double,
                   name.hasPrefix("chargeGroup") && value > 0 {
                    chargeGroupIDs.append(Int(value))
                }
            }
        }
        
        // 记录找到的弹药组
        Logger.info("模块 ID \(currentModuleID) 可装载弹药组: \(chargeGroupIDs)")
    }
}

// 模块状态选择器
struct ModuleStatusSelector: View {
    @Binding var selectedState: Int
    let availableStates: [Int]
    let onStateChanged: (Int) -> Void

    var body: some View {
        ModuleStatusView(
            availableStates: availableStates,
            selectedState: $selectedState,
            isEditable: true,
            onStateChanged: onStateChanged
        )
    }
}

// 弹药选择视图
struct ChargeSelectionView: View {
    let databaseManager: DatabaseManager
    let chargeGroupIDs: [Int]
    let typeID: Int
    let slotFlag: FittingFlag
    let viewModel: FittingEditorViewModel
    let module: SimModule
    let relatedModules: [SimModule]  // 新增：相关模块列表（用于批量操作）
    
    // 自定义回调函数
    var onChargeSelected: (Int, String, String?) -> Void
    var onClearCharge: () -> Void
    
    @State private var items: [DatabaseListItem] = []
    @State private var metaGroupNames: [Int: String] = [:]
    @State private var isLoading = true
    @Environment(\.dismiss) var dismiss
    
    // 使用原始viewModel初始化，但提供符合参考代码的回调方式
    init(
        databaseManager: DatabaseManager,
        chargeGroupIDs: [Int],
        typeID: Int,
        slotFlag: FittingFlag,
        viewModel: FittingEditorViewModel,
        module: SimModule,
        relatedModules: [SimModule]
    ) {
        self.databaseManager = databaseManager
        self.chargeGroupIDs = chargeGroupIDs
        self.typeID = typeID
        self.slotFlag = slotFlag
        self.viewModel = viewModel
        self.module = module
        self.relatedModules = relatedModules
        
        // 初始化回调函数 - 支持批量操作
        self.onChargeSelected = { chargeID, chargeName, iconFileName in
            if relatedModules.count > 1 {
                // 批量模式：为所有相关模块安装弹药
                let flags = relatedModules.compactMap { $0.flag }
                viewModel.batchInstallCharge(
                    typeId: chargeID,
                    name: chargeName,
                    iconFileName: iconFileName,
                    flags: flags
                )
                Logger.info("批量安装弹药: \(chargeName) 到 \(relatedModules.count) 个模块")
            } else {
                // 单个模式：只为当前模块安装弹药
                viewModel.installCharge(
                    typeId: chargeID,
                    name: chargeName,
                    iconFileName: iconFileName,
                    flag: slotFlag
                )
            }
        }
        
        self.onClearCharge = {
            if relatedModules.count > 1 {
                // 批量模式：清除所有相关模块的弹药
                let flags = relatedModules.compactMap { $0.flag }
                viewModel.batchRemoveCharge(flags: flags)
                Logger.info("批量清除弹药: \(relatedModules.count) 个模块")
            } else {
                // 单个模式：只清除当前模块的弹药
                viewModel.removeCharge(flag: slotFlag)
            }
        }
    }
    
    var body: some View {
        List {
            // 如果是批量模式，显示批量操作信息
            if relatedModules.count > 1 {
                Section(header: Text(NSLocalizedString("Fitting_Batch_Operation", comment: ""))) {
                    HStack {
                        Image(systemName: "square.stack.3d.up")
                            .foregroundColor(.blue)
                        VStack(alignment: .leading) {
                            Text(NSLocalizedString("Fitting_Batch_Ammo_Setting", comment: ""))
                                .font(.headline)
                            Text(String(format: NSLocalizedString("Fitting_Batch_Ammo_Description", comment: ""), relatedModules.count))
                                .font(.caption)
                                .foregroundColor(.secondary)
                        }
                        Spacer()
                    }
                    .padding(.vertical, 4)
                }
            }
            
            // 清除弹药选项
            Button(action: {
                onClearCharge()
                dismiss()  // 选择后关闭当前视图
            }) {
                HStack {
                    Text(NSLocalizedString("Fitting_Setting_No_Ammo", comment: ""))
                        .foregroundColor(.red)
                    Spacer()
                }
            }
            
            if isLoading {
                HStack {
                    ProgressView()
                    Text(NSLocalizedString("Misc_Loading", comment: ""))
                }
            } else {
                ForEach(groupedItems.keys.sorted(), id: \.self) { metaGroupID in
                    Section(header: Text(metaGroupNames[metaGroupID] ?? NSLocalizedString("Unknown", comment: ""))) {
                        ForEach(groupedItems[metaGroupID] ?? [], id: \.id) { item in
                            HStack {
                                DatabaseListItemView(item: item, showDetails: true)
                                Spacer()
                            }
                            .contentShape(Rectangle())
                            .onTapGesture {
                                onChargeSelected(item.id, item.name, item.iconFileName)
                                dismiss()  // 选择后关闭当前视图
                            }
                        }
                    }
                }
            }
        }
        .navigationTitle(Text(NSLocalizedString("Fitting_Setting_Ammo", comment: "")))
        .onAppear {
            loadCharges()
        }
    }
    
    private var groupedItems: [Int: [DatabaseListItem]] {
        Dictionary(grouping: items) { $0.metaGroupID ?? 0 }
    }
    
    private func loadCharges() {
        isLoading = true
        
        // 如果没有弹药组，直接返回
        if chargeGroupIDs.isEmpty {
            isLoading = false
            return
        }
        
        // 构建弹药组ID的字符串
        let groupIDsStr = chargeGroupIDs.map { String($0) }.joined(separator: ",")
        
        // 获取模块的chargeSize属性
        var chargeSize: Double? = nil
        
        // 直接从module的attributesByName中获取chargeSize
        if let size = module.attributesByName["chargeSize"] {
            Logger.info("模块的chargeSize属性值: \(size)")
            chargeSize = size
        }
        
        // 获取模块的容量
        var moduleCapacity: Double? = nil
        if let capacity = module.attributesByName["capacity"] {
            Logger.info("模块的capacity属性值: \(capacity)")
            moduleCapacity = capacity
        }
        
        // 构建SQL查询
        var whereClause = "t.groupID IN (\(groupIDsStr)) AND t.published = 1"
        var parameters: [Any] = []
        
        // 如果既有chargeSize又有容量限制，使用一个查询同时筛选
        if let size = chargeSize, let capacity = moduleCapacity, capacity > 0 {
            // 构建筛选chargeSize和体积的SQL
            let chargeQuery = """
                SELECT t1.type_id
                FROM typeAttributes t1
                JOIN dogmaAttributes d1 ON t1.attribute_id = d1.attribute_id
                JOIN types ty ON t1.type_id = ty.type_id
                WHERE d1.name = 'chargeSize' AND t1.value = ?
                AND ty.volume <= ?
                AND ty.groupID IN (\(groupIDsStr)) AND ty.published = 1
            """
            
            if case let .success(rows) = databaseManager.executeQuery(chargeQuery, parameters: [size, capacity]) {
                var typeIDs: [Int] = []
                for row in rows {
                    if let typeID = row["type_id"] as? Int {
                        typeIDs.append(typeID)
                    }
                }
                
                Logger.info("找到符合chargeSize和容量要求的弹药数量: \(typeIDs.count)")
                
                if !typeIDs.isEmpty {
                    // 使用IN查询直接获取符合条件的弹药
                    let typeIDsStr = typeIDs.map { String($0) }.joined(separator: ",")
                    whereClause = "t.type_id IN (\(typeIDsStr))"
                    parameters = []
                } else {
                    // 如果没有符合条件的弹药，返回空列表
                    items = []
                    isLoading = false
                    return
                }
            }
        } 
        // 只有chargeSize限制
        else if let size = chargeSize {
            whereClause += """
                AND t.type_id IN (
                    SELECT ta.type_id 
                    FROM typeAttributes ta
                    JOIN dogmaAttributes dat ON ta.attribute_id = dat.attribute_id
                    WHERE dat.name = 'chargeSize' AND ta.value = ? AND t.published = 1
                )
            """
            parameters.append(size)
            Logger.info("添加chargeSize筛选条件: \(size)")
        }
        // 只有容量限制
        else if let capacity = moduleCapacity, capacity > 0 {
            whereClause += """
                AND t.type_id IN (
                    SELECT type_id 
                    FROM types 
                    WHERE volume <= ? AND groupID IN (\(groupIDsStr)) AND published = 1
                )
            """
            parameters.append(capacity)
            Logger.info("添加容量筛选条件: \(capacity)")
        }
        
        // 获取所有符合条件的弹药
        items = databaseManager.loadMarketItems(whereClause: whereClause, parameters: parameters)
        Logger.info("找到 \(items.count) 种可用弹药")
        
        // 获取Meta组名称
        let query = """
            SELECT metagroup_id, name
            FROM metaGroups
        """
        
        if case let .success(rows) = databaseManager.executeQuery(query, parameters: []) {
            for row in rows {
                if let metaGroupID = row["metagroup_id"] as? Int,
                   let metaGroupName = row["name"] as? String {
                    metaGroupNames[metaGroupID] = metaGroupName
                }
            }
        }
        isLoading = false
    }
}

// 模块变体选择视图
struct ModuleVariationsView: View {
    let databaseManager: DatabaseManager
    let typeID: Int
    let onSelectVariation: (Int) -> Void
    
    @State private var items: [DatabaseListItem] = []
    @State private var metaGroupNames: [Int: String] = [:]
    @State private var isLoading = true
    @Environment(\.dismiss) var dismiss
    
    var body: some View {
        List {
            if isLoading {
                HStack {
                    ProgressView()
                    Text(NSLocalizedString("Misc_Loading", comment: ""))
                }
            } else {
                ForEach(groupedItems.keys.sorted(), id: \.self) { metaGroupID in
                    Section(header: Text(metaGroupNames[metaGroupID] ?? NSLocalizedString("Unknown", comment: ""))) {
                        ForEach(groupedItems[metaGroupID] ?? [], id: \.id) { item in
                            HStack {
                                DatabaseListItemView(item: item, showDetails: true)
                                Spacer()
                            }
                            .contentShape(Rectangle())
                            .onTapGesture {
                                onSelectVariation(item.id)
                                dismiss() // 只关闭变体选择器，返回到设置页
                            }
                        }
                    }
                }
            }
        }
        .navigationTitle(NSLocalizedString("Fitting_select_Variations", comment: ""))
        .onAppear {
            loadData()
        }
    }
    
    private var groupedItems: [Int: [DatabaseListItem]] {
        Dictionary(grouping: items) { $0.metaGroupID ?? 0 }
    }
    
    private func loadData() {
        isLoading = true
        let result = databaseManager.loadVariations(for: typeID)
        self.items = result.0
        self.metaGroupNames = result.1
        isLoading = false
    }
}
